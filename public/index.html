<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login with Mixpanel</title>
<script>
async function exchangeCode() {
  const code = document.getElementById("auth-code").value.trim();

  if (!code) {
    alert("Authorization code required");
    return;
  }

  try {
    // 1️⃣ Generate Access Token
    const tokenRes = await fetch("/exchange", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code })
    });

    const tokenData = await tokenRes.json();

    if (!tokenData.access_token) {
      document.getElementById("authorization-code").textContent = "Error generating token";
      document.getElementById("user-info").textContent = JSON.stringify(tokenData, null, 2);
      return;
    }

    const accessToken = tokenData.access_token;
    document.getElementById("authorization-code").textContent = "Access Token: " + accessToken;

    // 2️⃣ Get projects and create tags
    const projectsRes = await fetch("/projects", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ access_token: accessToken })
    });

    const projectsData = await projectsRes.json();
    document.getElementById("user-info").textContent = JSON.stringify(projectsData, null, 2);

  } catch (err) {
    document.getElementById("authorization-code").textContent = "Error: " + err;
  }
}

window.onload = () => {
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  if (code) {
    document.getElementById("auth-code").value = code;
  }
};
</script>
</head>
<body>
<h1>Login with Mixpanel</h1>

<input type="text" id="auth-code" placeholder="Paste authorization code here" />
<br><br>
<button onclick="exchangeCode()">Generate Access Token & Create Tags</button>

<p id="authorization-code"></p>
<h2>Projects & Tags</h2>
<pre id="user-info"></pre>
</body>
</html>
